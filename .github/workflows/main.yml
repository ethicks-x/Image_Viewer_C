on:
  push:
    branches:
      - main

jobs:
  test:
    name: Test on gcc (Meson wrap)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare apt and install system packages (no pip)
        run: |
          set -euo pipefail
          sudo apt-get update -y &>/dev/null
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            meson \
            ninja-build \
            git \
            curl \
            unzip \
            xvfb

      - name: Meson version (helpful to debug wrap support)
        run: |
          set -euo pipefail
          meson --version || { echo "meson not found or not runnable"; exit 1; }

      - name: Fetch Meson wrap dependency (sdl2)
        run: |
          set -euo pipefail
          # Ensure subprojects directory exists; meson wrap will populate it.
          mkdir -p subprojects
          echo "Running: meson wrap install sdl2"
          meson wrap install sdl2
          echo "meson wrap install completed; contents of subprojects:"
          ls -la subprojects || true

      - name: Configure and build with meson
        run: |
          set -euo pipefail
          # If meson.build is in a subdirectory, set the correct source dir (e.g., meson setup builddir path/to/source)
          meson setup builddir
          meson compile -C builddir

      - name: Run tests (use xvfb if tests require GUI)
        run: |
          set -euo pipefail
          if command -v xvfb-run >/dev/null 2>&1; then
            xvfb-run --auto-servernum meson test -C builddir --verbose
          else
            meson test -C builddir --verbose
          fi
